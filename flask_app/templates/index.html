<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../static/favicon.ico">

    <title>Ann's Mensa Tracker</title>

    <!-- Bootstrap core CSS -->
    <link href="../static/bootstrap-3.3.6-dist/css/bootstrap.min.css" rel="stylesheet">

    <link href="../static/datatables/datatables.css" rel="stylesheet" type="text/css"/>

      <!-- Our own CSS -->
      <link href="../static/ourcss.css" rel="stylesheet"/>

    <!--Moment.js library for formatting dates and times nicely-->
    <script src="../static/js/moment.min.js"></script>



  </head>

  <body>
    <!-- BEGIN site/header -->
    <div class="navbar navbar-default">
      <div class="container">
        <div class="navbar-header pull-left">
          <div class="navbar-brand">Ann's Mensa Tracker</div>
        </div>

        <!--Non-collapsable navbar elements-->
        <div class="navbar-header navbar-left">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                  data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>

        <!--Collapsable navbar elements-->
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="{{ url_for('mensa_history') }}">Menu Data</a></li>
            <li><a href="{{ url_for('about') }}">About</a></li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                Connect with us <b class="caret"></b></a>
              <ul class="dropdown-menu">
                <li><a href="http://eepurl.com/ct1h-P">Ann's Mensa Tracker mailing list</a></li>
                <li><a href="mailto:mensa.tracker@gmail.com">Email Ann</a></li>
              </ul>
            </li>
            {% if current_user.is_authenticated %}
            <li><a href="{{ url_for('logout') }}">Log out</a></li>
            {% else %}
            <li><a href="{{ url_for('oauth_authorize', provider='facebook') }}">Log in with Facebook</a></li>
            {% endif %}
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div class="container">
      <h1>Welcome to Ann's Mensa Tracker</h1>
      <p>Hi!  My Mensa Tracker can send you emails when your favorite dishes show
          up on the menu in the Mensa.</p>

      {% for message in get_flashed_messages() %}
        <p><b>Alert</b>: {{ message }}</p>
      {% endfor %}

      {% if current_user.is_authenticated %}
        <div class="row">
          <div class="col-sm-12">
            <div class="text-center saved-searches-header"><span id="saved_searches_table_header">
                You will get alerts for dishes that match the following search terms:
            </span></div>

            <div id="saved_searches_table_container">
              <table class="table table-striped table-vcenter row-border saved-searches"
                     id="saved_searches_table">
                <thead><tr>
                  <th class="hidden">Search ID</th>
                  <th>Search terms</th>
                  <th></th>
                </tr></thead>
                <tbody>
                  {% for search in current_user.searches.all() %}
                    <tr>
                      <td>saved_search_{{ search.id }}</td>
                      <td width="100%">"{{ search.search_terms }}"</td>
                      <td><div class="btn-group">
                          <a href="javascript:setSearchTerms('{{ search.search_terms }}'); runSearch();"
                              class="btn btn-lg btn-default">Test search</a>
                          <a href="javascript:deleteSearch({{ search.id }})"
                             class="btn btn-lg btn-danger">Delete</a>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>

            </div>
          </div>
        </div>
      {% endif %}

        <br/>
        <form name="testsearch" action="javascript:runSearch()">
          <div class="row" id="search-box">
            <div class="col-sm-12">
              <label class="control-label" for="search_terms">
                Try searching for a dish or an ingredient you like.</label>
              <input type="text" name="search_terms" id="search_terms"
                     placeholder="e.g. Bolognese, SchafkÃ¤se, Vanillesauce"
                     autocomplete="off" class="form-control"/>
            </div>
            <br/>
          </div>
        </form>
        <br/>

        <span id="search_results_placeholder"></span>
        <div id="search_results_container" class="hide-by-default" >
          <div class="row">
            <div class="col-sm-12">
              <div class="text-center"><h4><span id="search_results_header">Search results</span></h4></div>
              <table id="search_results_table" class="table table-striped">
                <thead><tr>
                  <th class="col-lg-2 col-md-2 col-sm-2 col-xs-2">Date</th>
                  <th class="col-lg-2 col-md-2 col-sm-2 col-xs-2">Mensa</th>
                  <th class="col-lg-2 col-md-2 col-sm-2 col-xs-2">Category</th>
                  <th class="col-lg-6 col-md-6 col-sm-6 col-xs-6">Item description</th>
                </tr></thead>
                <tbody>
                </tbody>
              </table>
            </div>
          </div>

          <br/>

          <div class="row">
            <div class="col-sm-12">
              <a href="javascript:saveSearch()" class="btn btn-primary btn-lg btn-block">
                Subscribe to alerts for this search</a>
            </div>
          </div>
        </div>

        <br/>

        <div class="row"><div class="col-sm-12">
          {% if current_user.is_authenticated %}
              You're logged in as {{ current_user.nickname }}.
              <p>
                {% if current_user.email == None %}
                    If you would like to receive email alerts,
                    <a href="{{ url_for('oauth_rerequest_permissions') }}">grant us permission here.</a>
                {% else %}
                    You will get email alerts at {{ current_user.email }}.
                    <a href="{{ url_for('delete_email_address') }}">Click here to unsubscribe.</a>
                {% endif %}
              </p>
          {% endif %}
        </div></div>
    </div>

    <footer class="container">
    <hr>
    <p>Ann's Mensa Tracker is a new service with lots of room for improvement.
      Please send your thoughts, ideas, and bug reports to
      <a href="mailto:mensa.tracker@gmail.com">mensa.tracker@gmail.com</a>.</p>
 </footer>


    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
{#    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>#}
    <script src="../static/js/jquery-1.11.3.js"></script>
    <script>window.jQuery || document.write('<script src="../static/bootstrap-3.3.6-src/docs/assets/js/vendor/jquery.min.js"><\/script>')</script>
    <script src="../static/bootstrap-3.3.6-dist/js/bootstrap.min.js"></script>
{#    <script src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>#}

    <script src="../static/datatables/datatables.js"></script>
    <script src="../static/js/datetime-moment.js"></script>

     <script>
         var table;

         var saved_searches_datatable;

         $(document).ready(function() {
             // Use datetime-moment.js to help us sort these dates properly
          $.fn.dataTable.moment('DD.MM.YYYY');

          table = $('#search_results_table').DataTable( {
              "order": [[0, "desc"]],
              "columnDefs": [
                { "orderable": false, "targets": 3 } // No sorting by description
                ],
              "searching": false,
              "pageLength": 5,
              "lengthChange": false,
              "fnInitComplete": function() {
                  hideSearchResults();  // Hide the table by default
              },
              "drawCallback": function() {
                  // Hide pagination controls unless there is more than one page
                  var pagination = $(this).closest('.dataTables_wrapper').find('.dataTables_paginate');
                  pagination.toggle(this.api().page.info().pages > 1);
              },
              "language": {
                  "emptyTable": "No search results found.",
                  "info": "_START_ to _END_ of _TOTAL_ results",
                  "infoEmpty": ""  // Hide "0 to 0 of 0 results"
              }
          });

          saved_searches_datatable = $('#saved_searches_table').DataTable( {
              "info": false,
              "ordering": false,
              "searching": false,
              "pageLength": 25,
              "lengthChange": false,
              "columnDefs": [
                  // Hide the search ID
                  { "visible": false, "targets": 0 },
                  // Center the "Delete search" and "Test search" buttons
                  { "className": "text-center", "targets": 2 }
              ],
              "drawCallback": function() {
                  var pagination = $(this).closest('.dataTables_wrapper').find('.dataTables_paginate');
                  pagination.toggle(this.api().page.info().pages > 1);
              }
          });

          if (saved_searches_datatable.rows().count() == 0) {
              hideSavedSearches();
          }
         } );

         function deleteSearch(search_id) {
            jQuery.post('/savedsearches/' + search_id + '/delete', {
                'search_id': search_id
            }).done(function(results) {
                if (results['status'] == 'success') {
                    // Delete the row corresponding to the search that was deleted
                    saved_searches_datatable.row(function(rowIndex, rowData, rowNode) {
                        return rowData[0] == ("saved_search_" + results['search_id']);
                    }).remove().draw(false);

                    // If there are no more saved searches to show, don't show the table any more.
                    if (saved_searches_datatable.rows().count() == 0) {
                        hideSavedSearches();
                    }

                } else if (results['status'] == 'failed') {
                    alert(results['reason'])
                }
            }).fail(function(error) {
                alert("Error communicating with the server.  Try refreshing the page.");
            })
         }

         function saveSearch() {
             var terms = getSearchTerms().trim();
             if (terms == "") {
                 alert("Please enter some search terms.");
                 return;
             }

             jQuery.post('/add_search', {
                 search_terms: terms
             }).done(function(results) {
                 if (results['status'] == 'success') {
                    saved_searches_datatable.row.add([
                        "saved_search_" + results['search_id'],
                        '"' + terms + '"',
                        buttons_for_search(terms, results['search_id'])
                    ]).draw(false);
                    showSavedSearches();

                 } else if (results['status'] == 'failed') {
                     alert(results['reason']);
                 } else {
                     alert("Received unknown status from server: " + status);
                 }
             }).fail(function(error) {
                 alert("Error communicating with the server.  Try refreshing the page.");
             })
         }


        function runSearch() {
            var terms = getSearchTerms().trim();
            if (terms == "") {
                return;
            }
            jQuery.post('/test_search', {
                search_terms: terms
            }).done(function(results) {
                document.getElementById('search_results_placeholder').textContent = "";
                table.clear();
                table.page('first');
                $.each(results, function (key, data) {
                    table.row.add( [
                        data['date_valid'],
                        data['mensa'],
                        data['category'],
                        data['description']
                    ])
                })
                table.draw(false);
                showSearchResults();
            }).fail(function(error) {
                document.getElementById('search_results_placeholder').textContent =
                    "We seem to be having trouble running your search.  " +
                    "Try refreshing the page.";
            })
            scroll_to_div($('#search-box'));
        }

         function hideSavedSearches() {
             $('#saved_searches_table_header').text("(Your subscriptions will be listed here.)");
             $('#saved_searches_table_container').hide();
         }

         function showSavedSearches() {
             $('#saved_searches_table_header').text("You will get alerts for dishes that match the following search terms:");
             $('#saved_searches_table_container').show()
         }

         function hideSearchResults() {
             $('#search_results_container').hide();
         }

         function showSearchResults() {
             $('#search_results_header').text("Search results for \"" + getSearchTerms() + "\"");
             $('#search_results_container').show();
         }

         function scroll_to_div(div) {
            $('html, body').animate({
              scrollTop: div.offset().top
            },1000);
          }


         function getSearchTerms() {
             return document.testsearch.search_terms.value;
         }

         function setSearchTerms(terms) {
             document.testsearch.search_terms.value = terms;
         }


         function buttons_for_search(search_terms, search_id) {
             var html = '<div class="btn-group">';
             html += "<a href=\"javascript:setSearchTerms('" + search_terms + "'); runSearch();\"";
             html += "class=\"btn btn-lg btn-default\" value=\"Test search\">Test search</a>";
             html += "<a href=\"javascript:deleteSearch(" + search_id + ")\"";
             html += "class=\"btn btn-lg btn-danger\" value=\"Delete\">Delete</a>";
             html += "</div>";
             return html;
         }

        function makeDelay(ms) {
          var timer = 0;
          return function(callback){
            clearTimeout(timer);
            timer = setTimeout(callback, ms);
          };
        };

        {#   Only run the search after the user stops typing for 500 ms.
             This prevents excessive server load.  #}
        var debounce = makeDelay(500);

        $("#search_terms").keyup(function(){
            debounce(runSearch);
        });

        </script>

  </body>
</html>
