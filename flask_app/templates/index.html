<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../static/favicon.ico">

    <title>Ann's Mensa Tracker</title>

    <!-- Bootstrap core CSS -->
    <link href="../static/bootstrap-3.3.6-dist/css/bootstrap.min.css" rel="stylesheet">

    <link href="../static/datatables/datatables.css" rel="stylesheet" type="text/css"/>

    <!--Moment.js library for formatting dates and times nicely-->
    <script src="../static/js/moment.min.js"></script>



  </head>

  <body>
    <!-- BEGIN site/header -->
    <div class="navbar navbar-default">
      <div class="container">
        <div class="navbar-header pull-left">
          <div class="navbar-brand">Ann's Mensa Tracker</div>
        </div>

        <!--Non-collapsable navbar elements-->
        <div class="navbar-header pull-right">
          <ul class="nav navbar-nav pull-right">
            {% if current_user.is_authenticated %}
            <li><a href="{{ url_for('logout') }}">Log out</a></li>
            {% else %}
            <li><a href="{{ url_for('oauth_authorize', provider='facebook') }}">Login with Facebook</a></li>
            {% endif %}
          </ul>
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>

        <!--Collapsable navbar elements-->
        <div id="navbar" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="{{ url_for('mensa_history') }}">Menu Data</a></li>
            <li><a href="{{ url_for('about') }}">About</a></li>
            <li><a href="mailto:ann.yanich@gmail.com">Contact</a></li>
            {% if current_user.is_authenticated %}
            <li><a href="#">Logged in as {{ current_user.nickname }}</a></li>
            {% endif %}
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </div>

    <div class="container">
        <h1>Welcome to Ann's Mensa Tracker</h1>
        <p>Hi!  My Mensa Tracker can send you emails when your favorite dishes show
            up on the menu in the Mensa.</p>

      {% for message in get_flashed_messages() %}
        <p><b>Alert</b>: {{ message }}</p>
      {% endfor %}

          {% if current_user.is_authenticated %}
        <p>
          {% if current_user.email == None %}
            Notice: We use your email address to send email alerts to you.
              If you would like to receive them,
            <a href="{{ url_for('oauth_rerequest_permissions') }}">give us permission to see your email address.</a>
          {% else %}
            Your registered email address is {{ current_user.email }}.<br>
            <a href="{{ url_for('delete_email_address') }}">To remove your email address, click here.</a>
            To change it, change your primary email address on Facebook.
          {% endif %}
          </p>

      {% endif %}


          <div class="row">
        <div class="col-sm-12">
            Type in part of the name of a dish you like to see
            a list of items that it would match.  </div></div>
        <br />
        <form name="testsearch" action="javascript:runSearch()">
        <div class="row">
            <div class="col-sm-12">
                <label class="control-label" for="search_terms">Search terms</label>
            <input type="text" name="search_terms" id="search_terms"
                   placeholder="e.g. Bolognese, Schafkäse, Vanillesauce" autocomplete="off"
                   class="form-control"/></div>
        </div>
        <br/>
        <div class="row">
            <div class="col-sm-12">
             <input type="submit" class="form-control btn btn-primary btn-block" value="Test Search" />
            </div>
        </div>
        </form>
        <br/>
        <div class="row">
        <div class="col-sm-12">
            <form action="javascript:saveSearch()">
                <input class="form-control btn btn-primary btn-block" type="submit" value="Save Search"></input>
            </form>
        </div>
        </div><br/>

      <div class="row">
        <div class="col-sm-7">
              <span id="search_results_placeholder"
{#                    style="white-space: pre;"#}
              >
{#                  Your search results will appear here.#}
              </span>
              <span id="search_results_table_container">
                  <div class="text-center"><h4><span id="search_results_table_header">Search results</span></h4></div>
              <table id="search_results_table" class="table table-striped">
                <thead><tr>
                    <th class="col-lg-2 col-md-2 col-sm-2 col-xs-2">Date</th>
                    <th class="col-lg-2 col-md-2 col-sm-2 col-xs-2">Mensa</th>
                    <th class="col-lg-2 col-md-2 col-sm-2 col-xs-2">Category</th>
                    <th class="col-lg-6 col-md-6 col-sm-6 col-xs-6">Item description</th>
                </tr></thead>
                <tbody>
                </tbody>
              </table></span>
          </div>

          <div class="col-sm-5">
              <div class="text-center"><h4><span id="saved_searches_table_header">Your saved searches</span></h4></div>
              <span id="saved_searches_table_container">
            <table class="table table-striped table-bordered table-condensed table-vcenter"
                    id="saved_searches_table">
              <thead><tr>
                  <th class="hidden">Search ID</th>
                  <th>Search terms</th>
{#                  <th>Date created</th>#}
                  <th class="text-center">Actions</th>
                </tr></thead>
              <tbody>
              {% if current_user.is_authenticated %}
                {% for search in current_user.searches.all() %}
                  <tr>
                    <td>saved_search_{{ search.id }}</td>
                    <td>"{{ search.search_terms }}"</td>
{#                    <td>{{ Momentjs(search.timestamp).format("LLL") }}</td>#}
                    <td class="text-center">
                        <a href="javascript:setSearchTerms('{{ search.search_terms }}'); runSearch();"
                            class="btn btn-lg btn-default" value="Test search">Test</a>
                        <a href="javascript:deleteSearch({{ search.id }})"
                           class="btn btn-lg btn-danger" value="Delete">Delete</a>
                    </td></tr>
                {% endfor %} {% endif %}
              </tbody></table></span>
{#                  Show some example searches#}
              <div class="text-center"><h4>Here are some examples for you to try: </h4></div>
              <table class="table table-striped table-bordered table-condensed table-vcenter">
{#              <thead><tr>#}
{#                  <th>Search terms</th>#}
{#                  <th class="text-center"></th>#}
{#                </tr></thead>#}
              <tbody>
                  <tr><td width="100%">"Bolognese"</td>
                  <td class="text-center"><form action="javascript:setSearchTerms('Bolognese'); runSearch();">
                        <button class="btn btn-lg btn-default" type="submit" value="Test search">Test search</button>
                  </form></td></tr>
                  <tr><td width="100%">"Schafkäse"</td>
                  <td class="text-center"><form action="javascript:setSearchTerms('Schafkäse'); runSearch();">
                        <button class="btn btn-lg btn-default" type="submit" value="Test search">Test search</button>
                    </form></td></tr>

              </tbody></table>

          </div>


          </div>
{#          <p><a href="{{ url_for('oauth_authorize', provider='facebook') }}">Login with Facebook</a></p>#}
    </div>





    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
{#    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>#}
    <script src="../static/js/jquery-1.11.3.js"></script>
    <script>window.jQuery || document.write('<script src="../static/bootstrap-3.3.6-src/docs/assets/js/vendor/jquery.min.js"><\/script>')</script>
    <script src="../static/bootstrap-3.3.6-dist/js/bootstrap.min.js"></script>
{#    <script src="https://cdn.datatables.net/1.10.12/js/jquery.dataTables.min.js"></script>#}

    <script src="../static/datatables/datatables.js"></script>
    <script src="../static/js/datetime-moment.js"></script>

     <script>
         var table;

         var saved_searches_datatable;

         $(document).ready(function() {
             // Use datetime-moment.js to help us sort these dates properly
          $.fn.dataTable.moment('DD.MM.YYYY');

          table = $('#search_results_table').DataTable( {
              "order": [[0, "desc"]],
              "columnDefs": [
                { "orderable": false, "targets": 3 }, // No sorting by description
                ],
              "searching": false,
              "pageLength": 5,
              "lengthChange": false,
              "fnInitComplete": function(oSettings, json) {
                  hideSearchResultsTable();  // Hide the table by default
              },
              "language": {
                  "emptyTable": "No search results found.", // Hide "No data available in table"
                  "info": "_START_ to _END_ of _TOTAL_ results"
              }
          });


          saved_searches_datatable = $('#saved_searches_table').DataTable( {
              "info": false,
              "ordering": false,
              "searching": false,
              "pageLength": 25,
              "lengthChange": false,
              "columnDefs": [
                { "visible": false, "targets": 0 } // ID is hidden
              ]
          });

          if (saved_searches_datatable.rows().count() == 0) {
              hideSavedSearches();
          }
         } );

         function deleteSearch(search_id) {
            jQuery.post('/savedsearches/' + search_id + '/delete', {
                'search_id': search_id
            }).done(function(results) {
                if (results['status'] == 'success') {
                    // Delete the row corresponding to the search that was deleted
                    saved_searches_datatable.row(function(rowIndex, rowData, rowNode) {
                        return rowData[0] == ("saved_search_" + results['search_id']);
                    }).remove().draw(false);

                    // If we just deleted the last row in the table, don't show the table any more.
                    if (saved_searches_datatable.rows().count() == 0) {
                        hideSavedSearches();
                    }

                } else if (results['status'] == 'failed') {
                    alert(results['reason'])
                }
            }).fail(function(error) {
                alert("Error communicating with the server.  Try refreshing the page.");
            })
         }

         function saveSearch() {
             var terms = document.testsearch.search_terms.value;
             if (terms == "") {
                 alert("Please enter some search terms.");
                 return;
             }

             jQuery.post('/add_search', {
                 search_terms: terms
             }).done(function(results) {
                 if (results['status'] == 'success') {
                    saved_searches_datatable.row.add([
                        "saved_search_" + results['search_id'],
                        '"' + terms + '"',
                        html_delete_button(results['search_id'])
                        + html_test_search_button(terms)
                    ]).draw(false);
                    showSavedSearches();

                 } else if (results['status'] == 'failed') {
                     alert(results['reason']);
                 } else {
                     alert("Received unknown status from server: " + status);
                 }
             }).fail(function(error) {
                 alert("Error: Search not saved?");
             })
         }


        function runSearch() {
            var terms = getSearchTerms();
            if (terms == "") {
                return;
            }
            jQuery.post('/test_search', {
                search_terms: terms
            }).done(function(results) {
                document.getElementById('search_results_placeholder').textContent = "";
                table.clear();
                table.page('first');
                $.each(results, function (key, data) {
                    table.row.add( [
                        data['date_valid'],
                        data['mensa'],
                        data['category'],
                        data['description']
                    ])
                })
                table.draw(false);
                showSearchResultsTable();
            }).fail(function(error) {
                document.getElementById('search_results_placeholder').textContent =
                    "We seem to be having trouble running your search.  " +
                    "Try refreshing the page.";
            })
        }

         function hideSavedSearches() {
             $('#saved_searches_table_header').text("Your subscriptions will be listed here.");
             $('#saved_searches_table_container').hide();
         }

         function showSavedSearches() {
             $('#saved_searches_table_header').text("Your saved searches");
             $('#saved_searches_table_container').show()
         }

         function hideSearchResultsTable() {
             $('#search_results_table_container').hide();
         }

         function showSearchResultsTable() {
             $('#search_results_table_header').text("Search results for \"" + getSearchTerms() + "\"");
             $('#search_results_table_container').show();
         }



         function getSearchTerms() {
             return document.testsearch.search_terms.value;
         }

         function setSearchTerms(terms) {
             document.testsearch.search_terms.value = terms;
         }

         function html_delete_button(search_id) {
             html = '<form class="text-center" action="javascript:deleteSearch(' + search_id + ');">';
             html += '<button class="btn btn-lg btn-danger" type="submit" value="Delete">Delete</button>';
             html += '</form>';
             return html;
         }

         function html_test_search_button(search_terms) {
            html = "<form class='text-center' action=\"javascript:setSearchTerms('" + search_terms;
            html += "'); runSearch();\">";
            html += '<button class="btn btn-lg btn-default" type="submit" value="Test search">Test</button>';
            html += '</form>';
            return html;
         }

        function makeDelay(ms) {
          var timer = 0;
          return function(callback){
            clearTimeout(timer);
            timer = setTimeout(callback, ms);
          };
        };

        {#   Only run the search after the user stops typing for 500 ms.
             This prevents excessive server load.  #}
        var debounce = makeDelay(500);

        $("#search_terms").keyup(function(){
            debounce(runSearch);
        });

        </script>

  </body>
</html>
